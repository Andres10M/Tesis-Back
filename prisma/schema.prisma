generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//
// ============================
// USUARIOS Y PERSONAS
// ============================
//

model User {
  id       Int     @id @default(autoincrement())
  username String  @unique
  password String
  enabled  Boolean @default(true)
  locked   Boolean @default(false)

  personId String? @unique
  person   Person? @relation(fields: [personId], references: [nui])

  @@map("users")
}

model Person {
  nui        String  @id
  firstname  String
  lastname   String
  address    String?
  phone      String?
  status     Boolean @default(true)
  categoryId Int?
  isDelete   Boolean @default(false)
  orderIndex Int     @default(0)

  accounts           Cuenta[]
  credits            Credit[]
  pagosMulta         PagoMulta[]
  attendances        Attendance[]
  creditosEspeciales CreditoEspecial[]
  user               User?

  category Category? @relation(fields: [categoryId], references: [id])

  fechaIngreso  DateTime?
  esSocioActivo Boolean  @default(false)
  limiteCredito Decimal? @default(2000)

  cuotas CuotaSocio[]
}

model Category {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  sector    String?
  location  String?
  createdAt DateTime @default(now())

  persons Person[]
}

//
// ============================
// CUENTAS
// ============================
//

model Cuenta {
  id          Int      @id @default(autoincrement())
  description String?
  balance     Decimal  @default(0)
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  personId    String

  person Person @relation(fields: [personId], references: [nui])

  finanzas      FinanzasCuenta?
  creditosMes   CreditoMensual[]
  aportes       Aporte[]
  transactions  Transaction[]
  credits       Credit[]
  amortizations Amortization[]
}

model FinanzasCuenta {
  id                Int      @id @default(autoincrement())
  cuentaId          Int      @unique
  capitalDic2024    Decimal  @default(0)
  aporteMensual2025 Decimal  @default(0)
  capitalJunio2025  Decimal  @default(0)
  createdAt         DateTime @default(now())

  cuenta Cuenta @relation(fields: [cuentaId], references: [id])
}

//
// ============================
// CRÃ‰DITOS MENSUALES
// ============================
//

model CreditoMensual {
  id        Int     @id @default(autoincrement())
  cuentaId Int
  anio     Int
  mes      Int
  monto    Decimal @db.Decimal(10,2)

  cuenta Cuenta @relation(fields: [cuentaId], references: [id])

  @@unique([cuentaId, anio, mes])
  @@map("credito_mensual")
}

//
// ============================
// APORTES ($2)
// ============================
//

model Aporte {
  id       Int      @id @default(autoincrement())
  amount   Decimal  @default(2.00)
  date     DateTime @default(now())
  anio     Int
  mes      Int
  cuentaId Int

  cuenta Cuenta @relation(fields: [cuentaId], references: [id])

  @@unique([cuentaId, mes, anio])
}

//
// ============================
// TRANSACCIONES
// ============================
//

model Transaction {
  id            Int      @id @default(autoincrement())
  tipo          String
  monto         Decimal
  fecha         DateTime @default(now())
  description   String?
  cuentaId      Int
  registradoPor String
  saldoActual   Decimal

  cuenta Cuenta @relation(fields: [cuentaId], references: [id])
}

//
// ============================
// CRÃ‰DITOS NORMALES
// ============================
//

model Credit {
  id           Int      @id @default(autoincrement())
  amount       Decimal
  interestRate Decimal
  status       String
  cuentaId     Int?
  personId     String
  startDate    DateTime
  endDate      DateTime?

  cuenta Cuenta? @relation(fields: [cuentaId], references: [id])
  person Person  @relation(fields: [personId], references: [nui])

  amortizations Amortization[]
}

model Amortization {
  id           Int      @id @default(autoincrement())
  creditId     Int
  cuentaId     Int
  fechaCalculo DateTime
  montoInteres Decimal

  credit Credit @relation(fields: [creditId], references: [id])
  cuenta Cuenta @relation(fields: [cuentaId], references: [id])
}

//
// ============================
// CRÃ‰DITOS ESPECIALES
// ============================
//

model CreditoEspecial {
  id            Int      @id @default(autoincrement())
  socioId       String
  montoPrestado Decimal  @db.Decimal(10,2)
  interes       Decimal  @db.Decimal(10,2)
  totalPagar    Decimal  @db.Decimal(10,2)
  anio          Int
  mes           Int
  fechaCredito  DateTime
  estado        EstadoCreditoEspecial @default(PENDIENTE)

  // ðŸ”½ TEMPORALMENTE OPCIONAL
  meetingId Int?
  meeting   Meeting? @relation(fields: [meetingId], references: [id], onDelete: Cascade)

  socio  Person @relation(fields: [socioId], references: [nui])
  abonos AbonoCreditoEspecial[]

  createdAt DateTime @default(now())

  @@map("credito_especial")
}


model AbonoCreditoEspecial {
  id                Int      @id @default(autoincrement())
  creditoEspecialId Int
  monto             Decimal  @db.Decimal(10,2)
  fecha             DateTime @default(now())
  registradoPor     String?

  creditoEspecial CreditoEspecial @relation(fields: [creditoEspecialId], references: [id])

  @@map("abono_credito_especial")
}

enum EstadoCreditoEspecial {
  PENDIENTE
  PAGADO
}

//
// ============================
// CUOTAS (INGRESO / 20 / 2)
// ============================
//

model CuotaSocio {
  id            Int      @id @default(autoincrement())
  socioId       String
  meetingId     Int?
  tipo          TipoCuota
  monto         Decimal  @db.Decimal(10,2)
  pagado        Boolean  @default(false)
  fechaPago     DateTime?
  registradoPor String?
  createdAt     DateTime @default(now())

  socio   Person   @relation(fields: [socioId], references: [nui])
  meeting Meeting? @relation(fields: [meetingId], references: [id], onDelete: Cascade)

  @@unique([socioId, meetingId, tipo])
}


enum TipoCuota {
  INGRESO
  CUOTA_20
  APORTE_2
}

//
// ============================
// REUNIONES / ASISTENCIAS
// ============================
//

model Meeting {
  id          Int      @id @default(autoincrement())
  fecha       DateTime
  descripcion String?
  createdAt   DateTime @default(now())
  isClosed    Boolean  @default(false)

  attendances Attendance[]
  cuotas      CuotaSocio[] 

  // ðŸ”½ NUEVO
  creditosEspeciales CreditoEspecial[]
}

model Attendance {
  id          Int              @id @default(autoincrement())
  fecha       DateTime         @default(now())
  multa       Decimal          @default(0)
  observacion String?
  justificado Boolean          @default(false)
  socioId     String
  estado      EstadoAsistencia
  meetingId   Int

  meeting Meeting @relation(fields: [meetingId], references: [id])
  person  Person  @relation(fields: [socioId], references: [nui])

  @@unique([socioId, meetingId])
  @@map("attendance")
}

model PagoMulta {
  id            Int      @id @default(autoincrement())
  socioId       String
  monto         Decimal
  fecha         DateTime @default(now())
  registradoPor String?

  socio Person @relation(fields: [socioId], references: [nui])
}

enum EstadoAsistencia {
  ASISTIO
  TARDE
  FALTA
}
